---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import AnimeList from '../../components/common/AnimeList.astro';
import Pagination from '../../components/react/Pagination';
import { getAnimeByGenre } from '../../api/animeApi';

const { genre } = Astro.params;

if (!genre) {
  return Astro.redirect('/404');
}

const genreId = parseInt(genre);
const page = parseInt(Astro.url.searchParams.get('page') || '1');

const genreNames: Record<number, string> = {
  1: 'Action', 2: 'Adventure', 4: 'Comedy', 8: 'Drama', 10: 'Fantasy', 
  14: 'Horror', 7: 'Mystery', 22: 'Romance', 24: 'Sci-Fi', 36: 'Slice of Life', 
  30: 'Sports', 37: 'Supernatural', 41: 'Suspense', 9: 'Ecchi', 49: 'Erotica', 
  12: 'Hentai', 18: 'Mecha', 38: 'Military', 19: 'Music', 6: 'Mythology', 
  40: 'Psychological', 21: 'Samurai', 23: 'School', 31: 'Super Power', 32: 'Vampire',
};

const genreName = genreNames[genreId] || `Genre ${genreId}`;

let animeResponse;
let errorMessage = '';

try {
  animeResponse = await getAnimeByGenre(genreId, page);
} catch (error) {
  console.error('Error fetching anime by genre:', error);
  errorMessage = 'Gagal memuat anime untuk genre ini.';
}
---

<Layout 
  title={`${genreName} Anime - AnimeYuk`}
  description={`Discover the best ${genreName} anime series and movies`}
>
  
  <div class="mb-10">
    <div class="mb-6 flex items-center gap-4">
      <a 
        href="/search"
        class="flex h-10 w-10 items-center justify-center rounded-full border border-gray-200 bg-white text-gray-500 hover:border-blue-500 hover:text-blue-600 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-400 dark:hover:text-blue-400 transition-all"
        title="Back to Search"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </a>
      
      <div>
        <p class="text-sm font-semibold uppercase tracking-wider text-blue-600 dark:text-blue-400">Genre</p>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white md:text-5xl">
          {genreName}
        </h1>
      </div>
    </div>

    <div class="scrollbar-hide overflow-x-auto pb-2">
      <div class="flex gap-2">
        {Object.entries(genreNames).slice(0, 10).map(([id, name]) => (
          <a 
            href={`/genre/${id}`}
            class:list={[
              'whitespace-nowrap rounded-full px-4 py-2 text-sm font-medium transition-colors border',
              parseInt(id) === genreId 
                ? 'border-blue-600 bg-blue-600 text-white dark:border-blue-500 dark:bg-blue-500' 
                : 'border-gray-200 bg-white text-gray-700 hover:border-blue-400 hover:text-blue-600 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-300 dark:hover:border-blue-400 dark:hover:text-blue-400' 
            ]}
          >
            {name}
          </a>
        ))}
        <span class="px-2 text-sm text-gray-400 self-center">...</span>
      </div>
    </div>
  </div>

  {errorMessage ? (
    <div class="mx-auto max-w-lg rounded-xl border border-red-200 bg-red-50 p-6 text-center text-red-600 dark:border-red-900/50 dark:bg-red-900/20 dark:text-red-400">
      <p class="font-medium">{errorMessage}</p>
    </div>
  ) : animeResponse && (
    <>
      {animeResponse.pagination && (
        <div class="mb-6 border-b border-gray-200 pb-2 dark:border-gray-800">
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Menampilkan <span class="font-bold text-gray-900 dark:text-white">{animeResponse.data.length}</span> anime
            {animeResponse.pagination.items?.total && (
              <> dari <span class="font-bold text-gray-900 dark:text-white">{animeResponse.pagination.items.total.toLocaleString()}</span> total</>
            )}
          </p>
        </div>
      )}

      {animeResponse.data.length > 0 ? (
        <>
          <AnimeList animes={animeResponse.data} />
          
          <div class="mt-12 flex justify-center">
            {animeResponse.pagination && (
              <Pagination
                client:only="react"
                currentPage={animeResponse.pagination.current_page}
                lastPage={animeResponse.pagination.last_visible_page}
                hasNextPage={animeResponse.pagination.has_next_page}
                baseUrl={`/genre/${genre}`}
              />
            )}
          </div>
        </>
      ) : (
        <div class="flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-200 py-16 text-center dark:border-gray-800">
          <div class="mb-4 text-5xl grayscale">ðŸ“º</div>
          <h2 class="mb-2 text-xl font-bold text-gray-900 dark:text-white">Tidak ada anime ditemukan</h2>
          <p class="mb-6 text-gray-500 dark:text-gray-400">Tidak ada anime untuk genre ini saat ini.</p>
          <a 
            href="/search"
            class="rounded-lg bg-blue-600 px-6 py-2.5 font-semibold text-white transition-colors hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600"
          >
            Jelajahi Anime Lainnya
          </a>
        </div>
      )}
    </>
  )}

  <section class="mt-20 border-t border-gray-200 pt-10 dark:border-gray-800">
    <h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-white">Browse All Genres</h2>
    <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5">
      {Object.entries(genreNames).map(([id, name]) => (
        <a 
          href={`/genre/${id}`}
          class:list={[
            'rounded-lg border px-4 py-3 text-center text-sm font-medium transition-all hover:shadow-sm',
            parseInt(id) === genreId
              ? 'border-blue-600 bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-400'
              : 'border-gray-200 bg-white text-gray-600 hover:border-blue-300 hover:text-blue-600 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-400 dark:hover:border-blue-500 dark:hover:text-blue-400'
          ]}
        >
          {name}
        </a>
      ))}
    </div>
  </section>
</Layout>